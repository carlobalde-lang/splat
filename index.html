<!DOCTYPE html>
<html lang="it">
<head>
    <script src="coi-serviceworker.js"></script>
    <meta charset="UTF-8">
    <title>Splat Hunter - Photorealistic Game</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #info-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 12px;
            pointer-events: none;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        h1 { margin: 0 0 10px 0; font-size: 1.5rem; letter-spacing: 1px; }
        p { margin: 5px 0; font-size: 0.9rem; color: #ccc; }
        #score { font-size: 1.2rem; color: #4ade80; font-weight: bold; }
        #crosshair {
            position: absolute;
            top: 50%; left: 50%;
            width: 20px; height: 20px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }
        .target-marker {
            position: absolute;
            width: 40px; height: 40px;
            border: 2px solid #ffeb3b;
            border-radius: 50%;
            animation: pulse 1s infinite;
            display: none;
        }
        @keyframes pulse { 0% {transform: scale(0.8); opacity: 1;} 100% {transform: scale(1.5); opacity: 0;} }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.3.9/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
</head>
<body>

    <div id="info-ui">
        <h1>üîç Splat Hunter</h1>
        <p>Trova il dettaglio nascosto nella scena!</p>
        <p>Obiettivo: <span id="target-desc">La sedia rossa</span></p>
        <p>Punteggio: <span id="score">0</span></p>
        <p style="font-size: 0.7rem; margin-top: 10px;">WASD per muoversi ‚Ä¢ Mouse per guardare ‚Ä¢ Click per interagire</p>
    </div>
    
    <div id="crosshair"></div>

    <script type="module">
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // 1. CONFIGURAZIONE SCENA
        const viewer = new Viewer({
            'cameraUp': [0, 1, 0],
            'initialCameraPosition': [0, 1.5, 4],
            'initialCameraLookAt': [0, 1, 0],
            'halfPrecisionCovariancesOnGPU': true, // Ottimizzazione performance
        });

        // *** IMPORTANTE: QUI VA IL LINK AL TUO FILE .SPLAT ***
        // Per testare, puoi usare un URL demo pubblico se ne hai uno, 
        // oppure un file locale (richiede un server locale).
        // Esempio: 'assets/mia-stanza.splat'
        const splatUrl = 'https://huggingface.co/datasets/dylanebert/3dgs/resolve/main/kitchen/kitchen-7k.splat'; 

        viewer.addSplatScene(splatUrl, {
            'splatAlphaRemovalThreshold': 5,
            'showLoadingUI': true,
            'position': [0, 0, 0],
            'rotation': [0, 0, 0, 1],
            'scale': [1, 1, 1]
        })
        .then(() => {
            console.log("Scena caricata ad alta fedelt√†!");
            viewer.start();
        });

        // 2. LOGICA DI GIOCO (RAYCASTING)
        let score = 0;
        const targetDesc = document.getElementById('target-desc');
        const scoreDisplay = document.getElementById('score');
        
        // Definiamo delle "Zone" segrete (Coordinate X, Y, Z approssimative)
        // In un gioco reale, queste coordinate le ottieni cliccando nella scena e loggando la posizione
        const hiddenObjects = [
            { name: "il rubinetto", position: new THREE.Vector3(-0.5, 1.2, -1.5), radius: 0.5, found: false },
            { name: "il pavimento di legno", position: new THREE.Vector3(0, 0, 0), radius: 1.0, found: false }
        ];
        
        let currentTargetIndex = 0;
        updateUI();

        function updateUI() {
            if (currentTargetIndex < hiddenObjects.length) {
                targetDesc.innerText = hiddenObjects[currentTargetIndex].name;
            } else {
                targetDesc.innerText = "Tutti gli oggetti trovati! Vittoria!";
                targetDesc.style.color = "#4ade80";
            }
        }

        // Gestione del Click
        document.addEventListener('click', () => {
            if (currentTargetIndex >= hiddenObjects.length) return;

            // Otteniamo la posizione della camera
            const camera = viewer.camera;
            
            // Creiamo un Raycaster dal centro dello schermo
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);

            // Nota: Il raycasting preciso sui Splat √® complesso (nuvola di punti).
            // Per questo mini-gioco, usiamo una logica semplificata basata sulla distanza
            // tra la posizione della camera + direzione sguardo e l'oggetto.
            
            // Calcoliamo dove il giocatore sta guardando (proiettiamo un punto in avanti)
            const lookVector = new THREE.Vector3();
            camera.getWorldDirection(lookVector);
            
            // Punto stimato di "tocco" a distanza variabile (es. 2 metri avanti)
            const targetPos = hiddenObjects[currentTargetIndex].position;
            
            // Calcolo distanza angolare (se sto guardando verso l'oggetto)
            const vectorToTarget = targetPos.clone().sub(camera.position).normalize();
            const angle = lookVector.angleTo(vectorToTarget); // In radianti

            // Se l'angolo √® piccolo (sto guardando l'oggetto) e sono abbastanza vicino
            const distanceToObj = camera.position.distanceTo(targetPos);
            
            // Soglia di precisione (0.2 radianti √® circa 11 gradi)
            if (angle < 0.2 && distanceToObj < 5) {
                // Successo!
                score += 100;
                scoreDisplay.innerText = score;
                hiddenObjects[currentTargetIndex].found = true;
                currentTargetIndex++;
                
                // Feedback visivo (opzionale)
                alert("Trovato: " + hiddenObjects[currentTargetIndex-1].name + "!");
                
                updateUI();
            } else {
                console.log("Mancato! Angolo:", angle, "Distanza:", distanceToObj);
            }
        });

    </script>
</body>
</html>